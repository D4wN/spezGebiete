<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<polymer-element name="weather-element"  attributes="lat lon">

    <template>
    <div id="weather">
        <h3>Weather Information</h3>
        <h4>Weather Today</h4>
        <li>Name: {{data.name}}</li><br>
        <li>Condition: {{data.conditiontext}}</li><br>
        <li>Temperature: <ul>Overall: {{data.tempLevel}}{{temperatureUnit}}</ul> <ul>Min: {{data.minTemp}}{{temperatureUnit}} </ul> <ul>Max: {{data.maxTemp}}{{temperatureUnit}}</ul></li><br>
        <li>Wind from: {{data.windDirection}} with {{data.windSpeed}}{{speedUnit}}</li><br>

        <h4>Weather Tomorrow</h4>
        <li>Condition: {{forecast.conditiontext}}</li><br>
        <li>Temperature: <ul>Overall: {{forecast.tempLevel}}{{temperatureUnit}}</ul> <ul>Min: {{forecast.minTemp}}{{temperatureUnit}} </ul> <ul>Max: {{forecast.maxTemp}}{{temperatureUnit}}</ul></li><br>
        <li>Wind from: {{forecast.windDirection}} with {{forecast.windSpeed}}{{speedUnit}}</li><br>

        <core-ajax id="ajax" auto
                   url="http://api.openweathermap.org/data/2.5/weather?lat={{lat}}&lon={{lon}}&lang={{language}}"
                   handleAs="json">
        </core-ajax>

        <core-ajax id="ajax2" auto
                   url="http://api.openweathermap.org/data/2.5/forecast/daily?lat={{lat}}&lon={{lon}}&lang={{language}}&cnt=2&mode=json"
                   handleAs="json">
        </core-ajax>

        </div>

    <style>
        #weather{
            background-color: limegreen;
        }
    </style>

        </template>


    <script>
        Polymer('weather-element',{
            language: "de",
            minmax: true,
            name: true,
            imperial: true,
            conditiontext: true,
            wind: true,
            suntimes: true,
            units: "metric",
            temperatureUnit:  " C",
            speedUnit: " km/h",
            lat: "",
            lon: "",
            minTemp: 0,
            maxTemp: 0,
            windDirections: ["N","NE","E","SE","S","SW","W","NW"],
            data: null,
            forecast: null,

            ready: function() {
                console.log(this.$.ajax2);
                this.$.ajax.addEventListener('core-response', function(e){
                    var res = e.detail.response;
                    var sunrise = new Date(res.sys.sunrise*1000);
                    var sunset = new Date(res.sys.sunset*1000);
                    function dateHelper(i) {
                        return i<10 ? "0" + i : i;
                    }
                    function getTempLevel(temp, isImperial) {
                        if (isImperial) { temp = (temp-32)*(5/9) }
                        var level = Math.round((temp + 8) / 8);
                        level = level < 0 ? 0 : level;
                        level = level > 6 ? 6 : level;
                        return level
                    }
                    this.data = {
                        conditiontext: res.weather[0].description,
                        name: res.name,
                        sunrise: dateHelper(sunrise.getHours()) + ":" + dateHelper(sunrise.getMinutes()),
                        sunset: dateHelper(sunset.getHours()) + ":" + dateHelper(sunset.getMinutes()),
                        currentTemp: Math.round(res.main.temp),
                        minTemp: getTempLevel(res.main.temp_min, this.imperial),
                        maxTemp: getTempLevel(res.main.temp_max, this.imperial),
                        windSpeed: res.wind.speed,
                        windDirection: this.windDirections[Math.round(res.wind.deg / 45) % 8],
                        cloudiness: res.clouds.all,
                        humidity: res.main.humidity,
                        pressure: res.main.pressure,
                        tempLevel: getTempLevel(res.main.temp, this.imperial)
                    };
                    this.fire('weather-element-load', {weather: this.data});
                }.bind(this));

                this.$.ajax2.addEventListener('core-response', function(e){
                    var res = e.detail.response;

                    function dateHelper(i) {
                        return i<10 ? "0" + i : i;
                    }
                    function getTempLevel(temp, isImperial) {
                        if (isImperial) { temp = (temp-32)*(5/9) }
                        var level = Math.round((temp + 8) / 8);
                        level = level < 0 ? 0 : level;
                        level = level > 6 ? 6 : level;
                        return level
                    }
                    this.forecast = {
                        conditiontext: res.list[1].weather[0].description,
                        name: res.city.name,
                        minTemp: getTempLevel(res.list[1].temp.min, this.imperial),
                        maxTemp: getTempLevel(res.list[1].temp.max, this.imperial),
                        windSpeed: res.list[1].speed,
                        windDirection: this.windDirections[Math.round(res.list[1].deg / 45) % 8],
                        cloudiness: res.list[1].clouds,
                        humidity: res.list[1].humidity,
                        pressure: res.list[1].pressure,
                        tempLevel: getTempLevel(res.list[0].temp.day, this.imperial)
                    };
                    this.fire('weather-element-load', {weather: this.forecast});
                }.bind(this));
            }
        });

    </script>

</polymer-element>